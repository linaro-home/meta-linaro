From b28f02ef2bf5098a43167a8c48dbcb853cd7d03a Mon Sep 17 00:00:00 2001
From: Anders Roxell <anders.roxell@linaro.org>
Date: Tue, 8 Oct 2013 22:26:51 +0200
Subject: [PATCH 3/3] scripts: arch dependent to get the syscall_list

ARCH may be changed in the enviroment

Signed-off-by: Anders Roxell <anders.roxell@linaro.org>
---
 scripts/find.sh                           | 11 ++++++++++-
 scripts/test-all-syscalls-parallel.sh     | 11 ++++++++++-
 scripts/test-all-syscalls-sequentially.sh | 11 ++++++++++-
 3 files changed, 30 insertions(+), 3 deletions(-)

diff --git a/scripts/find.sh b/scripts/find.sh
index 3f10c58..2687918 100755
--- a/scripts/find.sh
+++ b/scripts/find.sh
@@ -7,6 +7,15 @@
 
 TRINITY_PATH=${TRINITY_PATH:-.}
 TRINITY_TMP=$(mktemp -d /tmp/trinity.XXXXXX)
+ARCH=${ARCH:-x86}
+
+$TRINITY_PATH/trinity -L | grep entrypoint | grep -v AVOID | \
+    awk '{ print $4 }' | sort -u> $TRINITY_TMP/syscall_list
+
+if [ $ARCH = "arm" ]; then
+    $TRINITY_PATH/trinity -L | grep -v AVOID | \
+        awk '{ print $2 }' | sort -u> $TRINITY_TMP/syscall_list
+fi
 
 check_tainted()
 {
@@ -27,7 +36,7 @@ while [ 1 ];
 do
 
 
-for sc in $($TRINITY_PATH/trinity -L | grep entrypoint | grep -v AVOID | awk '{ print $4 }' | sort -u)
+for sc in $(cat $TRINITY_TMP/syscall_list)
 do
   mkdir -p tmp.$i
   pushd tmp.$i
diff --git a/scripts/test-all-syscalls-parallel.sh b/scripts/test-all-syscalls-parallel.sh
index 312fd2a..9c19f64 100755
--- a/scripts/test-all-syscalls-parallel.sh
+++ b/scripts/test-all-syscalls-parallel.sh
@@ -2,13 +2,22 @@
 
 TRINITY_PATH=${TRINITY_PATH:-.}
 TRINITY_TMP=$(mktemp -d /tmp/trinity.XXXXXX)
+ARCH=${ARCH:-x86}
+
+$TRINITY_PATH/trinity -L | grep entrypoint | grep -v AVOID | \
+    awk '{ print $4 }' | sort -u> $TRINITY_TMP/syscall_list
+
+if [ $ARCH = "arm" ]; then
+    $TRINITY_PATH/trinity -L | grep -v AVOID | \
+        awk '{ print $2 }' | sort -u> $TRINITY_TMP/syscall_list
+fi
 
 chmod 755 $TRINITY_TMP
 cd $TRINITY_TMP
 
 while [ 1 ];
 do
-  for syscall in $($TRINITY_PATH/trinity -L | grep entrypoint | grep -v AVOID | awk '{ print $4 }' | sort -u)
+  for syscall in $(cat $TRINITY_TMP/syscall_list)
   do
 	MALLOC_CHECK_=2 $TRINITY_PATH/trinity -q -c $syscall -D &
   done
diff --git a/scripts/test-all-syscalls-sequentially.sh b/scripts/test-all-syscalls-sequentially.sh
index 2b726fc..3eea70a 100755
--- a/scripts/test-all-syscalls-sequentially.sh
+++ b/scripts/test-all-syscalls-sequentially.sh
@@ -5,6 +5,15 @@
 
 TRINITY_PATH=${TRINITY_PATH:-.}
 TRINITY_TMP=$(mktemp -d /tmp/trinity.XXXXXX)
+ARCH=${ARCH:-x86}
+
+$TRINITY_PATH/trinity -L | grep entrypoint | grep -v AVOID | \
+    awk '{ print $4 }' | sort -u> $TRINITY_TMP/syscall_list
+
+if [ $ARCH = "arm" ]; then
+    $TRINITY_PATH/trinity -L | grep -v AVOID | \
+        awk '{ print $2 }' | sort -u> $TRINITY_TMP/syscall_list
+fi
 
 check_tainted()
 {
@@ -18,7 +27,7 @@ TAINT=$(cat /proc/sys/kernel/tainted)
 
 while [ 1 ]
 do
-for syscall in $($TRINITY_PATH/trinity -L | grep entrypoint | grep -v AVOID | awk '{ print $4 }' | sort -u)
+for syscall in $(cat $TRINITY_TMP/syscall_list)
 do
 	chmod 755 $TRINITY_TMP
 	pushd $TRINITY_TMP
-- 
1.8.1.2

